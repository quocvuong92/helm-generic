# Deployment with sidecars and init containers
# Tests: initContainers, sidecars, multiple volumes

workload:
  type: deployment
  replicas: 1

image:
  repository: nginx
  tag: "1.25-alpine"

ports:
  - name: http
    containerPort: 80

pod:
  initContainers:
    - name: init-config
      image: busybox:1.36
      command:
        - sh
        - -c
        - |
          echo "Preparing configuration..."
          cp /config-template/* /config/
          echo "Configuration ready"
      volumeMounts:
        - name: config-volume
          mountPath: /config-template
          readOnly: true
        - name: config-ready
          mountPath: /config

  sidecars:
    - name: log-shipper
      image: fluent/fluent-bit:2.1
      resources:
        limits:
          cpu: 100m
          memory: 64Mi
      volumeMounts:
        - name: logs
          mountPath: /var/log/nginx

    - name: metrics-exporter
      image: nginx/nginx-prometheus-exporter:0.11
      args:
        - -nginx.scrape-uri=http://localhost:80/nginx_status
      ports:
        - name: metrics
          containerPort: 9113
      resources:
        limits:
          cpu: 50m
          memory: 32Mi

  volumes:
    - name: logs
      emptyDir: {}
    - name: config-ready
      emptyDir: {}

  volumeMounts:
    - name: logs
      mountPath: /var/log/nginx
    - name: config-ready
      mountPath: /etc/nginx/conf.d

configFiles:
  - name: nginx-config
    mountPath: /etc/nginx/nginx.conf
    content: |
      worker_processes auto;
      events {
          worker_connections 1024;
      }
      http {
          server {
              listen 80;
              location / {
                  root /usr/share/nginx/html;
              }
              location /nginx_status {
                  stub_status on;
                  allow 127.0.0.1;
                  deny all;
              }
          }
      }

service:
  enabled: true
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 80
    - name: metrics
      port: 9113
      targetPort: 9113

serviceMonitor:
  enabled: true
  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
